---
title: "Run_Analysis"
format: html
---

# Source everything :D
```{r}
# Load all functions
source("./src/Source_Everything.R")
```


# Install Packages
```{r}
# List of needed packages
packages <- c(
  "diann",           # to extract the MaxLFQ matrix from DIANN report
  "arrow",           # to read the report.parquet file
  "here",            # to avoid the need for use the path while loading the data
  "tidyverse",       # to do the data wrangling, plots, etc...
  "janitor",         # to clean the column names
  "ggpointdensity",  # to reconstruct the m/z density map
  "naniar",          # for sparsity analysis
  "factoextra",      # to plot the PCA
  "patchwork",       # to combine plots
  "lsa",             # to calculate the cosine similarity
  "ggvenn",          # to plot the Venn diagram
  "paletteer",       # to use the nice color palette
  "ggtext",          # to provide Markdown and HTML formatting in ggplot2
  "ggrepel",         # to avoid the overlapping of the labels in the plots
  "kableExtra",      # to format the tables
  "limma",           # to calculate the differential abundance
  "DIAgui"           # (no comment provided)
)

Install_Packages(packages)
```


# Load samples names and relations
```{r}

# Name used for Run in the report.part
# tibble::view(unique(arrow::read_parquet("./data/input/report.parquet")$Run))


samplesDF <- read.csv2("./Data/input/sample_name_mapping.csv",
              header = TRUE,
              sep = ";")



fancyLabels <- setNames(samplesDF$PrettyName, samplesDF$SampleName)


samplesToCompare = list(
  MixB_vs_MixA = "MixB - MixA"
)


colors <- c(
  "#e31a1c","#1f78b4")

clusterColor <- c(
  "#e31a1c","#1f78b4")


genesToHighLight_BlandAltman <- c("ACL4","EIF1B","CAMK1","NECTIN1","CDC25C","RFA3 ","NUP57","SPHK1","NUC1","CDPF1","TNFAIP1","RDL2 ","H3-3A","SDCCAG8","RAB43","OST3","YDR391C","CDNF ","PAAT","SHE2","MICALL2","STT4","YNL108C","LMO4 ","BHLHE40","TRIQK","YIF1","HPM1","SENP8","HBG2","ROT2")


genesToCompare <- c("ACL4","EIF1B","CAMK1","NECTIN1","CDC25C")


```


```{r}
Check_Names(samplesDF$SampleName)

diannReport <- Make_DiannReport(samplesDF)
diannMatrix <- Make_DiannMatrix(diannReport, header = "Genes")

```


# Precursor x RT
```{r}
chromatogram <- Plot_Chromatogram(diannReport, fancyLabels, colors)

ggplot2::ggsave(
  filename = paste0("Chromatogram", ".png"),
  path = "./data/output/",
  plot = chromatogram,
  width = 12, height = 5,
  units = "in", dpi = 300
)

rm(chromatogram)
```


# Ion Cloud
```{r}
ionCloud <- Plot_IonCloud(diannReport, fancyLabels)

ggplot2::ggsave(
  filename = paste0("ionCloud", ".png"),
  path = "./data/output/",
  plot = ionCloud,
  width = 12, height = 5,
  units = "in", dpi = 300
)

rm(ionCloud)
```


# Number of Peptides and Proteins
```{r}
nPeptides <- Plot_nPeptides(diannReport, fancyLabels, colors)
nProteins <- Plot_nProteins(diannReport, labels = NULL, colors)

pept_and_prot <- patchwork::wrap_plots(nPeptides, nProteins, ncol = 2)

ggplot2::ggsave(
  filename = paste0("number_peptides_and_proteins", ".png"),
  path = "./data/output/",
  plot = pept_and_prot,
  width = 20, height = 10,
  units = "cm", dpi = 300
)

rm(nPeptides, nProteins, pept_and_prot)
```


# Sparsity Matrix
```{r}
sparsity <- Plot_Sparsity(diannMatrix, fancyLabels)

ggplot2::ggsave(
  filename = paste0("Sparsity", ".png"),
  path = "./data/output/",
  plot = sparsity,
  width = 4, height = 5,
  units = "in", dpi = 300
)

rm(sparsity)
```




# Data Imputation
```{r}
# imputedMatrix <- Create_ImputarionMatrix_MICE(
#   diannMatrix,
#   methodValue = "mean",
#   mValue = 1,
#   maxitValue = 3,
#   override = TRUE
# )

imputedMatrix <- Impute_StepWise(diannMatrix)
```


# Cosine Similarity
```{r}
cosine <- Plot_Cosine(
  imputedMatrix,
  fancyLabels
)

ggplot2::ggsave(
  filename = paste0("Cosine", ".png"),
  path = "./data/output/",
  plot = cosine,
  width = 20, height = 12,
  units = "in", dpi = 300
)
  
rm(cosine)
```


# PCA and K-Means
```{r}
kmeans <- Plot_kMeans(imputedMatrix, numberOfClusters = 2)
pca <- Plot_PCA(imputedMatrix, numberOfClusters = 2, clusterColors = clusterColor, labels = fancyLabels)

kmeans_and_pca <- patchwork::wrap_plots(kmeans, pca, ncol = 2)

ggplot2::ggsave(
  filename = paste0("kMeans_and_PCA", ".png"),
  path = "./data/output/",
  plot = kmeans_and_pca,
  width = 24, height = 10,
  units = "in", dpi = 300
)

rm(kmeans, pca, kmeans_and_pca)
```


# Coefficient of Variation
```{r}
CVs <- Plot_CV(
  imputedMatrix,
  conditions = unique(diannReport$condition),
  labelsName = fancyLabels,
  colorList = colors
)


ggplot2::ggsave(
  filename = paste0("Coef_Variation", ".png"),
  path = "./data/output/",
  plot = CVs,
  width = 10, height = 10,
  units = "in", dpi = 300
)

rm(CVs)
```


# Limma
```{r}
limmaContrasts <- Make_Limma_Contrast(imputedMatrix, samplesToCompare, method = "robust")

limmaResult <- Compare_Limma_Contrast(limmaContrasts, samplesToCompare)

# #Save limma result in a .tsv file
write.table(
  limmaResult,
  file = "./data/output/allLimmaResultsCombined.tsv",
  quote = FALSE,
  sep = '\t',
  col.names = NA
)


number_significantProteins <- Count_SignificantProteins(limmaResult)

#Save limma result in a .tsv file
write.table(
  number_significantProteins,
  file = "./data/output/number_significantProteins.tsv",
  quote = FALSE,
  sep = '\t',
  col.names = NA
)

rm(limmaContrasts, number_significantProteins)
```


# Bland-Altman
```{r}
blandAltman <- Plot_BlandAltman(
  limmaResult, 
  genesToHighLight_BlandAltman,
  labels = fancyLabels
)

ggplot2::ggsave(
  paste0("Bland_Altman", ".png"),
  path = "./data/output/",
  plot = blandAltman,
  width = 25, height = 12,
  units = "in", dpi = 300,
  bg = "white"
)


rm(blandAltman)
```


# Compare Proteins Abundance
```{r}
abundanceComparison <- Compare_Abundances(
  imputedMatrix,
  genes = genesToCompare,
  colorList = colors,
  labels = fancyLabels,
  n_columns = 5)


ggplot2::ggsave(
  paste0("Proteins_Comparison", ".png"),
  path = "./data/output/",
  plot = abundanceComparison,
  width = 25, height = 8,
  units = "in", dpi = 300,
  bg = "white"
)

rm(abundanceComparison)
```

