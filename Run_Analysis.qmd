---
title: "Run_Analysis"
format: html
---


```{r}
# Load all functions
source("./src/Source_Everything.R")
```


```{r}
# List of needed packages
packages <- c(
  "diann",           # to extract the MaxLFQ matrix from DIANN report
  "arrow",           # to read the report.parquet file
  "here",            # to avoid the need for use the path while loading the data
  "tidyverse",       # to do the data wrangling, plots, etc...
  "janitor",         # to clean the column names
  "ggpointdensity",  # to reconstruct the m/z density map
  "naniar",          # for sparsity analysis
  "factoextra",      # to plot the PCA
  "patchwork",       # to combine plots
  "lsa",             # to calculate the cosine similarity
  "ggvenn",          # to plot the Venn diagram
  "paletteer",       # to use the nice color palette
  "ggtext",          # to provide Markdown and HTML formatting in ggplot2
  "ggrepel",         # to avoid the overlapping of the labels in the plots
  "kableExtra",      # to format the tables
  "limma",           # to calculate the differential abundance
  "DIAgui"           # (no comment provided)
)

Install_Packages(packages)
```


# Load samples name and relations
```{r}
  samples <- c(
    P2_01 =  "NaCl_REP_1",
    P2_02 = "NaCl_REP_2",
    P2_03 =  "NaCl_REP_3",
    
    P2_04 = "Actinonin_15mg_REP_1",
    P2_05 =  "Actinonin_15mg_REP_2",
    P2_06 = "Actinonin_15mg_REP_3",
    P1_04 = "Actinonin_30mg_REP_1",
    P1_05 =  "Actinonin_30mg_REP_2",
    
    P2_11 = "JPM_OEt_50mg_REP_1",
    P2_12 =  "JPM_OEt_50mg_REP_2",
    P1_10 =  "JPM_OEt_100mg_REP_1",
    P1_11 = "JPM_OEt_100mg_REP_2",
    P1_12 =  "JPM_OEt_100mg_REP_3",
    
    P1_02 = "Venom_REP_1",
    P1_03 =  "Venom_REP_2",
    
    P2_07 =  "Ven_e_Actn_15mg_REP_1",
    P2_08 = "Ven_e_Actn_15mg_REP_2",
    P2_09 =  "Ven_e_Actn_15mg_REP_3",
    
    P1_07 = "Ven_e_Actn_30mg_REP_1",
    P1_08 =  "Ven_e_Actn_30mg_REP_2",
    P1_09 = "Ven_e_Actn_30mg_REP_3",
    
    P2_13 = "Ven_e_JPMOEt_50mg_REP_1",
    P2_14 =  "Ven_e_JPMOEt_50mg_REP_2",
    P2_15 = "Ven_e_JPMOEt_50mg_REP_3",
    
    P1_13 = "Ven_e_JPMOEt_100mg_REP_1",
    P1_14 =  "Ven_e_JPMOEt_100mg_REP_2",
    P1_15 = "Ven_e_JPMOEt_100mg_REP_3"
  )
  
  Check_SampleName(samples)
  # organism = "MOUSE"
  # parquetDIR <- "./data/input/report.parquet"
  # rdsDIR <- "./data/temp_files/diannReport.rds"

  prettyNames <- c(
   "NaCl_REP_1" = "NaCl r1",
   "NaCl_REP_2" = "NaCl r2",
   "NaCl_REP_3" = "NaCl r3",
   "NaCl" = "NaCl",
   
   "Actinonin_15mg_REP_1" = "Actinonin 15mg r1",
   "Actinonin_15mg_REP_2" = "Actinonin 15mg r2",
   "Actinonin_15mg_REP_3" = "Actinonin 15mg r3",
   "Actinonin_15mg" = "Actinonin 15mg",
   
   "Actinonin_30mg_REP_1" = "Actinonin 30mg r1",
   "Actinonin_30mg_REP_2" = "Actinonin 30mg r2",
   "Actinonin_30mg" = "Actinonin 30mg",
   
   "JPM_OEt_50mg_REP_1" = "JPMOEt 50mg r1",
   "JPM_OEt_50mg_REP_2" = "JPMOEt 50mg r2",
   "JPM_OEt_50mg" = "JPMOEt 50mg",
   
   "JPM_OEt_100mg_REP_1" = "JPMOEt 100mg r1",
   "JPM_OEt_100mg_REP_2" = "JPMOEt 100mg r2",
   "JPM_OEt_100mg_REP_3" = "JPMOEt 100mg r3",
   "JPM_OEt_100mg" = "JPMOEt 100mg",
   
   "Venom_REP_1" = "Venom r1",
   "Venom_REP_2" = "Venom r2",
   "Venom" = "Venom",
   
   "Ven_e_Actn_15mg_REP_1" = "Venom + Actinonin 15mg r1",
   "Ven_e_Actn_15mg_REP_2" = "Venom + Actinonin 15mg r2",
   "Ven_e_Actn_15mg_REP_3" = "Venom + Actinonin 15mg r3",
   "Ven_e_Actn_15mg" = "Venom + Actinonin 15mg",
   
   "Ven_e_Actn_30mg_REP_1" = "Venom + Actinonin 30mg r1",
   "Ven_e_Actn_30mg_REP_2" = "Venom + Actinonin 30mg r2",
   "Ven_e_Actn_30mg_REP_3" = "Venom + Actinonin 30mg r3",
   "Ven_e_Actn_30mg" = "Venom + Actinonin 30mg",
   
   "Ven_e_JPMOEt_50mg_REP_1" = "Venom + JPMOEt 50mg r1",
   "Ven_e_JPMOEt_50mg_REP_2" = "Venom + JPMOEt 50mg r2",
   "Ven_e_JPMOEt_50mg_REP_3" = "Venom + JPMOEt 50mg r3",
   "Ven_e_JPMOEt_50mg" = "Venom + JPMOEt 50mg",
   
   "Ven_e_JPMOEt_100mg_REP_1" = "Venom + JPMOEt 100mg r1",
   "Ven_e_JPMOEt_100mg_REP_2" = "Venom + JPMOEt 100mg r2",
   "Ven_e_JPMOEt_100mg_REP_3" = "Venom + JPMOEt 100mg r3",
   "Ven_e_JPMOEt_100mg" = "Venom + JPMOEt 100mg"
  )
  
  
  colors = c(
    "#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99",
    "#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a")
```


```{r}

Check_SampleName(samples)

diannReport <- Generate_DiannReport(samples, organism = "MOUSE")

precursorRT <- Generate_Graph_PrecursorRT(diannReport, prettyNames, colors)

ggplot2::ggsave(
  filename = paste0("Precursor_x_RT", ".png"),
  path = "./data/output/",
  plot = precursorRT,
  width = 210, height = 297, # A4
  units = "mm", dpi = 300
)

ionCloud <- Generate_IonCloud(diannReport, prettyNames)

ggplot2::ggsave(
  filename = paste0("ionCloud", ".png"),
  path = "./data/output/",
  plot = ionCloud,
  width = 210, height = 297, # A4
  units = "mm", dpi = 300
)

nPeptides <- Generate_Graph_NumberOfPeptides(diannReport, prettyNames, colors)

ggplot2::ggsave(
  filename = paste0("number_peptides", ".png"),
  path = "./data/output/",
  plot = nPeptides,
  width = 210, height = 297, # A4
  units = "mm", dpi = 300
)

nProteins <- Generate_Graph_NumberOfProteins(diannReport, prettyNames, colors)

ggplot2::ggsave(
  filename = paste0("number_proteins", ".png"),
  path = "./data/output/",
  plot = nProteins,
  width = 210, height = 297, # A4
  units = "mm", dpi = 300
)
```

```{r}
diannReport <- Generate_DiannReport(samples, organism = "MOUSE")
diannMatrix <- Generate_DiannMatrix(diannReport, header = "Genes")
sparsityMatrix <- Generate_SparsityMatrix(diannMatrix, prettyNames)

ggplot2::ggsave(
  filename = paste0("sparsityMatrix", ".png"),
  path = "./data/output/",
  plot = sparsityMatrix,
  width = 210, height = 297, # A4
  units = "mm", dpi = 300
)
```

```{r}
diannReport <- Generate_DiannReport(samples, organism = "MOUSE")
diannMatrix <- Generate_DiannMatrix(diannReport, header = "Genes")
imputedMatrix <- Create_ImputationMatrix_StepWise(diannMatrix)

cosineSimilarity <- Generate_Graph_CosineSimilarity(imputedMatrix,
                                                    samples,
                                                    prettyNames)

ggplot2::ggsave(
  filename = paste0("cosineSimilarity", ".png"),
  path = "./data/output/",
  plot = cosineSimilarity,
  width = 24, height = 10, #TODO:: Fix size in other ggsave()
  units = "in", dpi = 300)
  

kMeansPCA <- Generate_Graph_PCA_and_Kmeans(imputedMatrix,
                                           numberOfClusters = 8,
                                           clusterColors = colors,
                                           labels = prettyNames)

ggplot2::ggsave(
  filename = paste0("kMeans_PCA", ".png"),
  path = "./data/output/",
  plot = kMeansPCA,
  width = 24, height = 10,
  units = "in", dpi = 300)



CVs <- Generate_Graph_Coef_Variation(
  imputedMatrix,
  conditions = unique(diannReport$condition),
  labelsName = prettyNames,
  colorList = colors
)


ggplot2::ggsave(
  filename = paste0("Coef_Variation", ".png"),
  path = "./data/output/",
  plot = CVs,
  width = 10, height = 10,
  units = "in", dpi = 300)
```