---
title: "Run_Analysis"
format: html
---

# Source everything :D
```{r}
source("./src/Source_Everything.R") # Load all functions
source("./LoadSamples.R") # Load samples and relations

diannReport <- Make_DiannReport(samplesDF, organism = "")
# Install_Packages(packages)
```

# Get all the strings for the .csv
```{r}
csvList <- list.files(
  c("./data/output/matrices/basic/", "./data/output/matrices/MICE/"),
  pattern = "*.csv$",
  full.names = TRUE,
  ignore.case = TRUE
)
```


# Quality Analysis
```{r}
# Iterate over the directory of the imputed .csv
for (dir in csvList) {
  #read the .csv
  imputed <- as.matrix(tibble::column_to_rownames(
    read.csv(dir),
    var = "X"
  ))

  # clean up the graph name
  name <- stringr::str_to_title(
    stringr::str_replace_all(
      stringr::str_remove(basename(dir), ".csv$"),
      "_",
      " "
    )
  )

  # Cosine Similarity
  cosine <- Plot_Cosine(imputed, fancyLabels)

  # k-Means
  optimalCluster <- Get_OptimalCluster(imputed)

  # PCA
  pca <- Plot_PCA(
    imputed,
    numberOfClusters = optimalCluster,
    clusterColors = clusterColor,
    labels = fancyLabels
  )

  # Coefficient of Variation
  #TODO: remove (Log2 + 1)
  CVs <- Plot_CV(
    imputed, 2^(imputed - 1), #Todo: Something is wrong !!!
    unique(diannReport$condition),
    fancyLabels,
    colors
  )

  # Aggregate all plots for better visualization
  combine <- patchwork::wrap_plots(
    list(cosine, pca, CVs),
    cols = 3,
    nrow = 1
  ) +
    # Plot title and general formatting
    patchwork::plot_annotation(
      title = name,
      tag_levels = "A",
      theme = ggplot2::theme(
        plot.title = ggplot2::element_text(
          face = "bold",
          size = "35",
          hjust = 0.5,
          vjust = 0.5
        ),
      )
    )

  # Save the plot file
  ggplot2::ggsave(
    filename = paste0("quality_", stringr::str_replace_all(name, " ", "_"), ".png"),
    path = "./data/output/quality/",
    plot = combine,
    width = 80,
    height = 30,
    units = "cm",
    dpi = 300
  )

  rm(cosine, optimalCluster, pca, CVs, combine, name, dir)
  break
}
```


# Resize the margins for plot (bottom, left, top right)
# par(mar = c(2, 4, 2, 4) + 0.1)

# # Create a Densisty plot
# densityPlot <- plot(density(log2(diannMatrix + 1), na.rm = TRUE), main = "udhisud")
# lines(density(imputed, na.rm = TRUE), col = "red", lty = 5)


