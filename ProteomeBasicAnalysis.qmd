---
title: "Proteoma Basic Analysis"
author: "Pedro Galdiano de Castro"
execute:
  echo: false
  warning: false
  message: false
format: html
code-fold: true
editor_options:
  chunk_output_type: console
---

# 1) Load packages dependencies
```{r}
library(diann) # to extract the MaxLFQ matrix from DIANN report
library(arrow) # to read the report.parquet file
library(here) # to avoid the need for use the path while loading the data
library(tidyverse) # to do the data wrangling, plots, etc...
library(janitor) # to clean the column names
library(ggpointdensity) # to reconstruct the m/z density map
library(naniar) # for sparsity analysis
library(factoextra) # to plot the PCA
library(patchwork) # to combine plots
library(lsa) # to calculate the cosine similarity
library(ggvenn) # to plot the Venn diagram
library(paletteer) # to use the nice color palette
library(ggtext) # to provide Markdown and HTML formatting in ggplot2
library(ggrepel) # to avoid the overlapping of the labels in the plots
library(kableExtra) # to format the tables
library(limma) # to calculate the differential abundance
library(DIAgui) # to extract iBAQ values

cat("\n\n1) All packages were activated.\n")
```

# 2) Global variables
```{r}
# This map should be ordered by the sample-name (code = sample_name), this will
# define the order everything will be ploted
#
# A amostra precisa terminar com espaço, letra r , número (" r1", " r2", " r637")
# Sim, é uma gambiarra.Preciso resolver

labels <- c(
  P2_01 =  "NaCl r1",
  P2_02 = "NaCl r2",
  P2_03 =  "NaCl r3",

  P1_02 = "Venom r1",
  P1_03 =  "Venom r2",
  
  P2_04 = "Actinonin 15mg r1",
  P2_05 =  "Actinonin 15mg r2",
  P2_06 = "Actinonin 15mg r3",
  P1_04 = "Actinonin 30mg r1",
  P1_05 =  "Actinonin 30mg r2",
  
  P2_11 = "JPMOEt 50mg r1",
  P2_12 =  "JPMOEt 50mg r2",
  P1_10 =  "JPMOEt 100mg r1",
  P1_11 = "JPMOEt 100mg r2",
  P1_12 =  "JPMOEt 100mg r3",
  
  P2_07 =  "Ven & Actn 15mg r1",
  P2_08 = "Ven & Actn 15mg r2",
  P2_09 =  "Ven & Actn 15mg r3",
  
  P1_07 = "Ven & Actn 30mg r1",
  P1_08 =  "Ven & Actn 30mg r2",
  P1_09 = "Ven & Actn 30mg r3",
  
  P2_13 = "Ven & JPM-OEt 50mg r1",
  P2_14 =  "Ven & JPM-OEt 50mg r2",
  P2_15 = "Ven & JPM-OEt 50mg r3",
  
  P1_13 = "Ven & JPM-OEt 100mg r1",
  P1_14 =  "Ven & JPM-OEt 100mg r2",
  P1_15 = "Ven & JPM-OEt 100mg r3"
)

# Params to filter by
params <- list(
  pgScore = 0.75,
  eqScore = 0.75,
  threshold = 0.3,
  samplesToRemove = c("NaCl r1"),
  setSeed = 333, #random seed
  
  #Fix the text in the number of proteins and peptides plot
  nMaxPeptides = 8200,
  nMaxProteins = 1200,
  
  #Params to create imputation Matrix
  imputMethod = "rf",
  imputM = 1,
  imputMaxit = 10,
  imputSeed = 50,
  imputOverride = FALSE,
  
  numberOfClusters = 4,
  
  #If more or different colors are need just go to "colorbrewer2.org"
  colors = c(
    "#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99",
    "#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a")

)

checkLabels <- function() {
  conditions = unique(stringr::str_remove_all(labels, " r[0-9]+"))
  
  for (condition in conditions) {
    
    occurrences = sum(stringr::str_detect(conditions, condition))
    
    if (occurrences > 1) {
      cat("\nO nome dessa condição está contido em outra condição:", 
          condition,
          "\nPor favor, renomeie.")
      break
    }
  }
}

cat("\n\n2) Global variables were loaded.\n\n")
checkLabels()
```

# 3) Helper functions ----
```{r}
# Return a dataset with the coefficients of variation
CV_Matrix <- function(data, condition) {

  selected <- dplyr::select(
    data,
    protein,
      str_subset(colnames(data), condition)
    )

  selected_rowwise <- rowwise(selected)

  mutated <- dplyr::mutate(selected_rowwise,
    across(where(is.numeric), ~ 2^(.) - 1),
    cv = 100 *
      (
        sd(c_across(where(is.numeric)), na.rm = TRUE) /
          mean(c_across(where(is.numeric)), na.rm = TRUE)
      ),
    condition = condition
  )
  to_return <- dplyr::select(mutated, protein, cv, condition)
  
  
  # browser()
  
  return(dplyr::select(mutated, protein, cv, condition))
}

# Generate the diannReport.rds from report.parquet file
DiannReport <- function(runs, directory = "../data/DIANN_results/") {

  report <- arrow::read_parquet(paste(directory, "report.parquet", sep = ""))

  reportFiltered <- dplyr::filter(
    report,
    Lib.PG.Q.Value <= 0.01 &
      Lib.Q.Value <= 0.01 &
      PG.Q.Value <= 0.01
  )

  reportRecoded <- dplyr::mutate(reportFiltered,
    Run = recode(Run, !!!runs),
    Run = factor(Run, levels = unname(runs)),
    condition = str_remove(Run, " r[0-9]+"),
    File.Name = Run,
    peptide_length = nchar(Stripped.Sequence)
  )

  diannReport <- dplyr::filter(
    reportRecoded,
    str_detect(Protein.Names, "MOUSE")
  )

  cat("\ndiannReport were loaded.")

  return(diannReport)
}

FilterByScore <- function(data) {

  result <- data %>%
    as.data.frame() %>%
    dplyr::filter(PG.MaxLFQ.Quality > params$pgScore &
      Empirical.Quality > params$eqScore)

  cat("\nPG.MaxLFQ.Quality >", params$pgScore,
    "\nEmpirical.Quality >", params$eqScore)

  return(result)
}

FilterBySample <- function(data) {
  
  cat("\nSample removed:", params$samplesToRemove)

  cols <- colnames(data)
  return(data[, (!cols %in% params$samplesToRemove)])
}

FilterByDiannMatrix <- function(data) {

  result <- data %>%
    diann::diann_matrix(id.header = "Protein.Group",
      quantity.header = "Genes.MaxLFQ.Unique",
      proteotypic.only = TRUE,
      pg.q = 0.01)

  cat("\n\nFilter by unique genes using Diann_Matrix")
  return(result)
}

FilterByMissingness <- function(data) {


  MeanOfMissing <- function(x) {
    return(mean(is.na(x)))
  }
  
  df <- as.data.frame(data)

  result <- dplyr::mutate(df, prot_miss = apply(df, 1, MeanOfMissing)) %>%

    dplyr::filter(prot_miss <= params$threshold) %>%
    dplyr::select(-prot_miss)

  cat("\nMissingness threshold <=", params$threshold)

  return(as.matrix(result))
}

CleanDiannReport <- function() {

  diannReport <- DiannReport(labels) # Not sure if the best approach is to get it inside the function or pass as argument

  fileName <- "cleanDiannReport"

  result <- diannReport %>%
    FilterByScore() %>%
    FilterByDiannMatrix() %>%
    FilterBySample() %>%
    FilterByMissingness()
  # No console da a entender que o FilterBySample está sendo chamado antes do
  # FilterByScore, mas não é o caso. É só uma anomalia do %>%.

  cat("\n")
  cat(fileName, "were loaded")

  return(result)
}

cat("\n\n3) Helper functions were loaded.\n")
```

# 4) Graph functions ----
```{r}
GenBarGraph <- function(data, xValue, yValue, condition, xLabel, nmax) {
  ggplot(data, aes(
    y = yValue,
    x = xValue,
    fill = condition
  )) +
    geom_bar(
      stat = "identity",
      position = "dodge",
      show.legend = FALSE
    ) +
    scale_fill_manual(values = params$colors) +
    geom_text(
      aes(
        label = xLabel,
        hjust = ifelse(xLabel > nmax, 1.1, -0.15)
      ),
      color = "black",
      size = 7, nudge_x = -0.5
    ) +
    labs(
      y = NULL,
      x = xLabel,
      fill = NULL
    ) +
    theme(
      text = element_text(size = 17),
      axis.text.x = element_text(
        angle = 90, vjust = 0.5, hjust = 1
      ),
      panel.border = element_rect(color = "black", fill = NA),
      panel.background = element_blank()
    )
}


SparsityPlot <- function(df) {
  df %>%
    as.data.frame() %>%
    naniar::vis_miss() +
    labs(
      x = NULL,
      y = "Number of proteins"
    ) +
    theme(
      text = element_text(size = 20),
      axis.text.y = element_text(color = "black", vjust = 1),
      axis.text.x = element_text(
        angle = 90, color = "black"
      ),
      line = element_blank(),
      panel.background = element_blank()
    )
}

  theme_update(
    text = element_text(color = "black", size = 20),
    axis.text = element_text(color = "black"),
    axis.title = element_text(color = "black", face = "bold"),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold", hjust = 0.5),
    legend.title.position = "top"
)  
  


cat("\n\n4) Graph functions were loaded.\n")
```

# 5) Graph: Precursor x RT / Density Map ----
```{r}
# Reconstruction of the ion chromatograms, the precursor quantity is
#  plotted over the retention time (min) for each sample.
GraphPrecursorRT_mzMapDensity <- function() {
  diannReport <- DiannReport(labels)

  precursorRT <- diannReport %>%
    ggplot(aes(x = RT, y = Precursor.Quantity)) +
    geom_line(aes(color = condition), show.legend = FALSE) +
    scale_color_manual(values = params$colors) +
    labs(
      x = "Retention time (min)",
      y = "Precursor quantity",
      color = NULL
    ) +
    facet_wrap(~Run, ncol = 6, scales = "free") +
    theme(
      strip.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA),
      panel.background = element_blank()
    )

  # For the m/z map, the density of ions collected is plotted over
  # the scan range (m/z) for each sample.
  mzMapDensity <- diannReport %>%
    ggplot(aes(x = RT, y = Precursor.Mz)) +
    ggpointdensity::geom_pointdensity(size = 0.1) +
    viridis::scale_color_viridis(option = "H") +
    scale_x_continuous(limits = c(0, 90)) +
    labs(
      x = "Retention time (min)",
      y = "Scan range (m/z)",
      color = NULL
    ) +
    facet_wrap(~Run, scales = "free", ncol = 6) +
    theme(
      strip.background = element_blank(),
      legend.position = "bottom",
      legend.key.width = unit(1.5, "cm"),
      legend.key.height = unit(0.25, "cm"),
      panel.border = element_rect(color = "black", fill = NA),
      panel.background = element_blank()
    )


  precursorRT_and_mzMapDensity <- (precursorRT / mzMapDensity) +
    plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 30, face = "bold"))

  ggsave(
    filename = paste0(quote(precursorRT_and_mzMapDensity), ".png"),
    path = "plots",
    plot = precursorRT_and_mzMapDensity,
    width = 24, height = 20,
    units = "in", dpi = 300
  )

  cat("\n\n5) Graph ", quote(precursorRT_and_mzMapDensity), ".png were created.\n", sep = "")

  # return(precursorRT_and_mzMapDensity)
}

GraphPrecursorRT_mzMapDensity()
```

# 6) Graph: Peptides | Proteins ----
```{r}
# Counting the number of unique peptides and proteins per run
GraphNumberOfPeptidesAndProteins <- function() {
  diannReport <- DiannReport(labels)

  diannReportByRun <- diannReport %>%
    dplyr::group_by(Run, condition) %>%
    dplyr::summarise(
      n_peptides = n_distinct(Stripped.Sequence),
      n_proteins = n_distinct(Protein.Ids))

  totalUniquePeptides <- n_distinct(diannReport$Stripped.Sequence)
  totalUniqueProteins <- n_distinct(diannReport$Protein.Ids)

  # Create the peptides graph
  peptidesPlot <- diannReportByRun %>%
    ggplot(aes(y = Run, x = n_peptides, fill = condition)) +
    geom_bar(stat = "identity", position = "dodge", show.legend = FALSE) +
    scale_fill_manual(values = params$colors) +
    geom_text(
      aes(
        label = n_peptides,
        hjust = ifelse(n_peptides > params$nMaxPeptides, 1.1, -0.15)
      ),
      color = "black", size = 7, nudge_x = -0.5, fontface = "bold"
    ) +
    labs(y = NULL, x = "Number of peptides", fill = NULL) +
    theme(
      text = element_text(size = 25),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
      panel.border = element_rect(color = "black", fill = NA),
      panel.background = element_blank()
    )

  # Create the proteins graph
  proteinsPlot <- diannReportByRun %>%
    ggplot(aes(y = Run, x = n_proteins, fill = condition)) +
    geom_bar(stat = "identity", position = "dodge", show.legend = FALSE) +
    scale_fill_manual(values = params$colors) +
    geom_text(
      aes(
        label = n_proteins,
        hjust = ifelse(n_proteins > params$nMaxProteins, 1.1, -0.15)
      ),
      color = "black", size = 7, nudge_x = -0.5, fontface = "bold"
    ) +
    labs(y = NULL, x = "Number of proteins", fill = NULL) +
    theme(
      text = element_text(size = 25),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
      panel.border = element_rect(color = "black", fill = NA),
      panel.background = element_blank()
    )


  # Concatenate peptides plot and proteins plot
  number_of_peptides_and_proteins <- (peptidesPlot | proteinsPlot) +
    plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 30, face = "bold"))

  # Save file
  ggsave(
    filename = paste(quote(number_of_peptides_and_proteins), ".png", sep = ""),
    path = "plots",
    plot = number_of_peptides_and_proteins,
    width = 24, height = 20,
    units = "in", dpi = 300
  )

  cat("\n6) Graph ", quote(number_of_peptides_and_proteins), ".png were created.\n",
    "Total number of unique  peptides: ", totalUniquePeptides,
    "\nTotal number of unique proteins: ", totalUniqueProteins, "\n",
    sep = ""
  )

  # return(peptidesPlot)
}

GraphNumberOfPeptidesAndProteins()
```

# 7) Graph: Sparsity Matrix ----
```{r}
# Genes.MaxLFQ.Unique: matriz de abundância de intensidade normalizada com algoritmo MAX LFQ sendo calculada a partir de peptídeos únicos (peptídeos que dão match apenas com uma proteína)
GraphSparsityMatrix <- function() {
  diannReport <- DiannReport(labels)

  uniqueGenes <-  FilterByDiannMatrix(diannReport) # me retorna uma matrix
  sparsityPlotRaw <- SparsityPlot(uniqueGenes) # converto para df dentro da func plot

  # Create a sparsity plot with unique genes FILTERED
  uniqueGenesFiltered <- diannReport %>%
    FilterByScore() %>%
    FilterBySample() %>%
    FilterByDiannMatrix()

  sparsityPlotFiltered <- SparsityPlot(uniqueGenesFiltered)


  # Create a sparsity plot with unique genes REDUCED and FILTERED
  uniqueGenesCleaned <- CleanDiannReport()
  sparsityPlotCleaned <- SparsityPlot(uniqueGenesCleaned)


  sparsity_matrix <- (sparsityPlotRaw | sparsityPlotFiltered | sparsityPlotCleaned) +
    plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 30, face = "bold"))

  ggsave(
    filename = paste0(quote(sparsity_matrix), ".png"),
    path = "plots",
    plot = sparsity_matrix,
    width = 24, height = 20,
    units = "in", dpi = 300
  )

  cat("\n\n7) Graph ", quote(sparsity_matrix), ".png were created.\n", sep = "")

}

GraphSparsityMatrix()
```

# 8) Graph: QuanUMS Evaluation ----
```{r}
GraphQuantUMS <- function() {

  diannReport <- DiannReport(labels)

  lowScoresPeptide <- diannReport %>%
    dplyr::filter(PG.MaxLFQ.Quality < params$pgScore &
      Empirical.Quality < params$eqScore) %>% 
    dplyr::group_by(Run) %>%
    dplyr::summarise(
      n = n_distinct(Stripped.Sequence))

  quantUMS <- diannReport %>%
    ggplot(aes(x = PG.MaxLFQ.Quality,
      y = Empirical.Quality)) +

    geom_pointdensity(size = 0.5) +

    geom_vline(xintercept = 0.75, linetype = "dashed", color = "black") +
    geom_hline(yintercept = 0.75, linetype = "dashed", color = "black") +
    viridis::scale_color_viridis(option = "plasma") +

    geom_text(data = lowScoresPeptide,
      aes(x = 0.25, y = 0.35, label = n),
      hjust = -0.1, vjust = 0.5,
      size = 9, fontface = "bold",
      color = "red", show.legend = FALSE) +

    labs(title = "QuantUMS scores for feature selection",
      x = "pgQ Score",
      y = "eQ Score",
      color = NULL) +

    facet_wrap(~Run, ncol = 6) +
    theme(plot.title = element_text(size = 30,
      face = "bold", hjust = 0.5),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 20),
    text = element_text(size = 20),
    axis.title = element_text(size = 30),
    axis.text.x = element_text(color = "black",
      angle = 90, vjust = 0.5, hjust = 1),
    legend.position = "none",
    panel.border = element_rect(color = "black", fill = NA),
    panel.background = element_rect(fill = "white")
    )

  ggsave(
    filename = paste(quote(quantUMS), ".png", sep = ""),
    path = "plots",
    plot = quantUMS,
    width = 24, height = 20,
    units = "in", dpi = 300
  )

  cat("\n8) Graph ", quote(quantUMS), ".png were created.\n", sep = "")
}

GraphQuantUMS()
```

# 9) Create Imputation Matrix ----
```{r}
CreateImputationMatrix <- function() {
  
  filenameImputation <- paste0("imputedMatrix_", params$imputMethod, ".rds")
  filenameResult <- paste0("result_", filenameImputation)
  
  filesExists <- (file.exists(filenameImputation) | file.exists(filenameResult))
  
  if (!(params$imputOverride) & filesExists) {
    
    cat("\nLoad file:", filenameResult,"\n")
    invisible(read_rds(filenameResult))
    
  } else {
    
    uniqueGenesCleaned <- CleanDiannReport()
    
    matrixForImputation <- log2(uniqueGenesCleaned + 1) %>%
      as.data.frame() %>%
      rownames_to_column(var = "protein") # %>%
    
    cat("\nCreating the imputed matrix.\n\nThis is going to take a while.\n")
    set.seed(params$setSeed)
    imputedMatrix <- mice::mice(matrixForImputation,
                                method = params$imputMethod,
                                m = params$imputM,
                                maxit = params$imputMaxit,
                                seed = params$imputSeed)
    
    result <- mice::complete(imputedMatrix)
    
    cat("\n\nCreate files:\n", filenameImputation, "\n", filenameResult)
    write_rds(imputedMatrix, file = filenameImputation)
    write_rds(result, file = filenameResult)
    
    invisible(result)
  }
}

CreateImputationMatrix()
cat("\n9) Imputation matrix were loaded.")
```


# 10) Graph: Cosine Similarity ----
```{r}
GraphCosSimilarity <- function() {

  cosineSimilarity <- CreateImputationMatrix() %>%
    column_to_rownames("protein") %>%
    as.matrix() %>%
    lsa::cosine() %>%
    as.data.frame() %>%
    rownames_to_column(var = "Sample") %>%
    pivot_longer(-Sample, names_to = "Match") %>% # não entendi essa desgraça

    dplyr::mutate(Similarity = "Cosine similarity",
      Sample = factor(Sample, levels = unname(labels)),
      Match = factor(Match, levels = unname(labels))) %>%

    ggplot() +
    geom_tile(aes(x = Sample, y = Match, fill = value)) +
    viridis::scale_fill_viridis(option = "E") +
    labs(title = "Similarity matrix",
      x = NULL,
      y = NULL,
      fill = "Cosine similarity") +
    # theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"),
      text = element_text(size = 20),
      axis.text.x = element_text(angle = 90,
        hjust = 1, vjust = 0.5, color = "black"),
      axis.text.y = element_text(angle = 0,
        hjust = 1, vjust = 0.5, color = "black"),
      legend.position = "bottom",
      legend.title.position = "top",
      legend.title = element_text(hjust = 0.5),
      legend.key.width = unit(2.5, "cm"),
      legend.key.height = unit(0.3, "cm"),
      panel.border = element_rect(color = "black", fill = NA),
      panel.background = element_blank())

  ggsave(
    filename = paste(quote(cosineSimilarity), ".png", sep = ""),
    path = "plots",
    plot = cosineSimilarity,
    width = 24, height = 20,
    units = "in", dpi = 300)

  cat("\n10) Graph ", quote(cosineSimilarity), ".png were created.\n", sep = "")
}

GraphCosSimilarity()
```

# 11) Graph: Principal Component Analysis (PCA) by K-means 
```{r}
GraphPCA_Kmeans <- function() {
  pcaComplete <- CreateImputationMatrix() %>%
    column_to_rownames("protein") %>%
    t() %>%
    prcomp(scale = TRUE)

  pcaTwoDimensions <- as.data.frame(pcaComplete$x[, 1:2]) #não precisa ser DF

  kmeans_clusters_p <- fviz_nbclust(pcaTwoDimensions,
    FUNcluster = kmeans,
    method = "wss") +

    geom_point(size = 4, color = "steelblue") +
    geom_vline(xintercept = params$numberOfClusters, linetype = "dashed") +
    theme_minimal() +
    labs(title = "Optimal number of clusters") +
    theme(plot.title = element_text(hjust = 0.5),
      text = element_text(color = "black", size = 20),
      title = element_text(color = "black", size = 20, face = "bold", hjust = 0.5),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black", face = "bold"),
      axis.ticks = element_line(color = "black"),
      panel.border = element_rect(color = "black", fill = NA))
  
  set.seed(params$setSeed)
  kMeansPCA <- kmeans(pcaTwoDimensions, centers = params$numberOfClusters)

  pcaPlot <- fviz_pca_ind(pcaComplete,
    geom = c("point", "text"),
    habillage = kMeansPCA$cluster,
    labelsize = 7, pointsize = 3,
    palette = params$colors,
    addEllipses = FALSE,
    ggtheme = theme_classic(),
    repel = TRUE) +

    labs(title = "PCA clustered by k-means") +
    theme_minimal() +

    theme(plot.title = element_text(hjust = 0.5),
      text = element_text(color = "black", size = 20),
      title = element_text(color = "black", size = 20,
        face = "bold", hjust = 0.5),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black", face = "bold"),
      strip.background = element_rect(fill = "grey90"),
      strip.text = element_text(face = "bold"),
      legend.title = element_text(face = "bold", hjust = 0.5),
      legend.title.position = "top",
      legend.position = "none",
      panel.border = element_rect(color = "black", fill = NA))


  kMeans_PCA <- (kmeans_clusters_p | pcaPlot) +
    plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 30, face = "bold"))

  ggsave(
    filename = paste(quote(kMeans_PCA), ".png", sep = ""),
    path = "plots",
    plot = kMeans_PCA,
    width = 24, height = 10,
    units = "in", dpi = 300
  )

  cat("\n\n11) Graph ", quote(pcaPlot_and_kMeansPCA), ".png were created.\n", sep = "")

}

GraphPCA_Kmeans()
```

# 12) Graph: Coefficient of Variation [REFACTOR!] ----
```{r}
GraphCoefficientOfVariation <- function() {

  imputationResult <- CreateImputationMatrix()

  conditions <- unique(DiannReport(labels)$condition)
  CVs <- data.frame()

  cat("\nCalculating Coefficient of Variation...")

  for (condition in conditions) {
    CVs <- bind_rows(CVs,
      CV_Matrix(imputationResult,
        condition = condition))
  }

  CVs %>%
    dplyr::mutate(condition = factor(condition,
      levels = unique(str_remove(unname(labels), "_r[0-9]+"))))


  CVplot <- CVs %>%
    ggplot(aes(y = condition, x = cv, fill = condition)) +
    geom_violin(linewidth = 0.2) +
    geom_boxplot(width = 0.2, fill = "white",
      linewidth = 0.2, outlier.alpha = 0.5) +
    geom_vline(xintercept = 20, linetype = "dashed", color = "black") +
    scale_fill_manual(values = params$colors) +
    labs(
      y = NULL,
      x = "Coefficient of variation (%)",
      fill = NULL) +
    theme_linedraw() +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 20, face = "bold"),
      axis.text = element_text(color = "black", size = 20, face = "bold"),
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
      axis.ticks = element_line(),
      line = element_blank(),
      strip.background = element_blank(),
      strip.text = element_text(size = 20, face = "bold", color = "black"))

  ggsave(
    filename = paste(quote(CVplot), ".png", sep = ""),
    path = "plots",
    plot = CVplot,
    width = 12, height = 10,
    units = "in", dpi = 300)

  cat("\n\n12) Graph ", quote(CVplot), ".png were created.\n", sep = "")
}

#GraphCoefficientOfVariation()
```





# 13) Graph: Bland-Altman [TODO] ----
```{r}
# TODO:

cat("\n\n13) ")
```

# 14) Graph: Distribution of proteins of interest [TODO] ----
```{r}
# TODO:

cat("\n\n14) ")
```

